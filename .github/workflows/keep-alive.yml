name: Restart Streamlit App

on:
  schedule:
    # æ¯6å°æ—¶é‡å¯ä¸€æ¬¡
    - cron: '0 */6 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  restart-streamlit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Trigger Streamlit Cloud restart
        env:
          STREAMLIT_API_KEY: ${{ secrets.STREAMLIT_API_KEY }}
          APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          echo "Restarting Streamlit app at $(date)"
          
          # æ–¹æ³•1: é€šè¿‡ Streamlit Cloud API é‡å¯
          if [ -n "$STREAMLIT_API_KEY" ]; then
            curl -X POST "https://share.streamlit.io/api/v1/apps/restart" \
              -H "Authorization: Bearer $STREAMLIT_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"app_url": "'"$APP_URL"'"}'
          fi
          
          # æ–¹æ³•2: é€šè¿‡ä¿®æ”¹ä»“åº“è§¦å‘é‡æ–°éƒ¨ç½²
          # Streamlit Cloud ä¼šç›‘å¬ main åˆ†æ”¯çš„å˜åŒ–
          date > .streamlit_restart_timestamp
          git config --local user.email "bot@github.com"
          git config --local user.name "Restart Bot"
          git add .streamlit_restart_timestamp
          git commit -m "ğŸ”„ Auto restart: $(date '+%Y-%m-%d %H:%M:%S')" || echo "No changes"
          
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: Wait and verify
        run: |
          echo "Waiting for app to restart..."
          sleep 90
          
          # å¥åº·æ£€æŸ¥
          if [ -n "${{ secrets.APP_URL }}" ]; then
            curl -f "${{ secrets.APP_URL }}/health" || echo "Health check skipped"
          fi
          
          echo "âœ… Restart workflow completed"
