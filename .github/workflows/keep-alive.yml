name: Smart Restart

# Ëøô‰∏™ÊñπÊ°àÈÄöËøá‰øÆÊîπ‰∏Ä‰∏™ËôöÊãüÁöÑÁâàÊú¨Âè∑Êù•Ëß¶ÂèëÈáçÂêØ
# ‰∏ç‰ºöÂú®‰ª£Á†Å‰∏≠Á¥ØÁßØÂûÉÂúæÊ≥®Èáä

on:
  schedule:
    # ÊØè4Â∞èÊó∂ÊâßË°å‰∏ÄÊ¨°
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  smart-restart:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Update restart version
        run: |
          echo "üîÑ Updating restart trigger..."
          
          # ÂàõÂª∫ÊàñÊõ¥Êñ∞‰∏Ä‰∏™‰∏ìÈó®ÁöÑÁâàÊú¨Êñá‰ª∂
          mkdir -p .streamlit
          
          # Ëé∑ÂèñÂΩìÂâçÈáçÂêØÊ¨°Êï∞
          if [ -f ".streamlit/restart_version.txt" ]; then
            current=$(cat .streamlit/restart_version.txt)
          else
            current=0
          fi
          
          # ÈÄíÂ¢ûÁâàÊú¨Âè∑
          next=$((current + 1))
          echo $next > .streamlit/restart_version.txt
          
          # Âú® requirements.txt Êú´Â∞æÊ∑ªÂä†‰∏Ä‰∏™ËôöÊãüÁâàÊú¨Âè∑
          # Streamlit ‰ºöÊ£ÄÊµãÂà∞ requirements.txt ÂèòÂåñÂπ∂ÂÆåÂÖ®ÈáçÂêØ
          if [ -f "requirements.txt" ]; then
            # ÂÖàÂà†Èô§ÊóßÁöÑÁâàÊú¨Ë°å
            grep -v "^# restart-version:" requirements.txt > requirements.txt.tmp || true
            mv requirements.txt.tmp requirements.txt
            
            # Ê∑ªÂä†Êñ∞ÁöÑÁâàÊú¨Ë°å
            echo "# restart-version: $next" >> requirements.txt
            echo "‚úÖ Updated to restart version $next"
          else
            echo "‚ö†Ô∏è requirements.txt not found"
          fi
      
      - name: Commit & Push
        run: |
          git config user.name "restart-bot"
          git config user.email "restart-bot@users.noreply.github.com"
          
          git add .streamlit/restart_version.txt
          if [ -f "requirements.txt" ]; then
            git add requirements.txt
          fi
          
          version=$(cat .streamlit/restart_version.txt)
          git commit -m "üîÑ Restart v${version}: $(date '+%Y-%m-%d %H:%M UTC')"
          git push
          
          echo "‚úÖ Pushed restart trigger v${version}"
          echo "üì± Streamlit Cloud will detect the change and restart"
      
      - name: Wait and verify
        if: vars.APP_URL != ''
        run: |
          echo "‚è≥ Waiting 2 minutes for restart..."
          sleep 120
          
          if curl -f -s "${{ vars.APP_URL }}" > /dev/null; then
            echo "‚úÖ App is responding!"
          else
            echo "‚ö†Ô∏è App check failed (might still be restarting)"
          fi
